/*                                                                                                          

````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
```````````````````````````.````````````````````````````````````````````````````````````````````````
``````````````````-.-:/:---s:::-----````````````````````````````````````````````````````````````````
``````````````````-os:+s.s/y:+y.s++y````````````````````````````````````````````````````````````````
```````````````````-..-.`:--..-`.-.-```````````````.-:+ossssso+:-.``````````````````````````````````
``````````````````:.:://:y:-:/.`---------```````-+ydmNNNNNNNNNNNmds:.```````````````````````````````
``````````````````.oo:+s-y//oo/`-::::::::````./ymNNNNNNNNNNNNNNNNNNmh/``````````````````````````````
```````````````````.....-...-..`````````````-yNNNNNNNNNNdmNNNNNNNNNNNNy-````````````````````````````
```````````````````````````````````````````:mNNNNNNNddm+.-dNNNNNNmsmNNNd:```````````````````````````
``````````````````````````````````````````-mNNNNNNNd.`.`  /NNNNNmo::ymNNm-``````````````````````````
`````````````````````````````````````````.hNNNNNNNNNs:.`  /NNNNmo/:--/hNNh``````````````````````````
`````````````````````````````````````````oNNNNNNNNNNNNNdy+dNNNdyso:---+yNN-`````````````````````````
````````````````````````````````````````:NNNNNNNNNNNNNNNNNNNms///+:-----hN:`````````````````````````
```````````````````````````````````````.dNNNNNNNNNNNNNNNNNmy///h+/:--:-oyN-`````````````````````````
```````````````````````````````````````yNNNNNNNNddNNNNNNmy+///+Ny/:--+ohhy``````````````````````````
``````````````````````````````````````/NNNNNNNNy/o+dNNds///////o+/:---h/:h``````````````````````````
`````````````````````````````````````-mNNNNNNNNo/h+/++////////////:---/y-y.`````````````````````````
````````````````````````````````````-dNNNNNNNNNd/syo//////////////:---++-y-`````````````````````````
``````````````````````````````````-smNNNNNNNNNNNmyo+++////////////:------y.`````````````````````````
```````````````````````````````-odNNNNNNNNNNNNNNNNNNNNs/////////osoooo---h``````````````````````````
`````````````````````````````-sNNNNNNNNNNNNNNNNNNNNNNNsy//////////:-----s:``````````````````````````
````````````````````````````+mNNNNNNNNNNNNNNNNNNNNNNNs//ss+///////:----o+```````````````````````````
```````````````````````````:NNNNNNNNNNNNNNNNNNNNNNNNy/////osso+///::/oo:````````````````````````````
```````````````````````````+NNNNNNNNNNNNNNNNNNNNNNNd//////////+hmms/-.``..-:/+osyh:`````````````````
```````````````````````````.mNNNNNNNNNNNNNNNNNNNNNd///////////oNNhosyhdmNNNMMMMMMM:`````````````````
````````````````````````````/mNNNNNNNNNNNNNNNNNNNmo+oosyhhdmNNMMMMMMMMNmdmMNo//mMM:`````````````````
`````````````````````````````+NNNNNNNNNNNNNNNMMMMNNNMMMMMMNNMMhysN/:-My.`.d/ `hMMM:`````````````````
``````````````````````````.-+dNNNMMMMMMMMMMMMMNNmMMNso+N-..:mm  `m  `NMh` ` `hMMMM:`````````````````
``````````````````````oyhdmNMMMMMMMNmmdhhdNMMo..`oMd  `N    -h  `m  `NMMd`  sMMMMM:`````````````````
``````````````````````dMMNdhhyooohM-.`.. `:Md  ` `hd  `N  `/ .  `m   so+:`  hMMMMM:`````````````````
``````````````````````dMMs.  .:  .M`  so  -N- .o  .h  `N  `No   `N`..-:/+osyNMMMMM:`````````````````
``````````````````````dMMN:  -:  +N`  `  .mo  `.`  -  .N..:MMyoyhMdmNNMMMMNNmmdhhy-`````````````````
``````````````````````dMMM/  :s.  y`  y-  /``:ddh/osyhdMmNNMMMMNNmmdhyso+/:--..`````````````````````
``````````````````````dMMd-  .-`./m:-/NmsyhdmNMMMMMNNmmdhyso+/::--..````````````````````````````````
``````````````````````dMMy/+oyhdmMMNMMMMNNmmdhyso+/::-..````````````````````````````````````````````
``````````````````````dMMMMMNNNmddhso+//:-..````````````````````````````````````````````````````````
``````````````````````syso+/:--..```````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
```````````````````````````````---.---::--.-:--:.-:-:.--:-:.----.---.```````````````````````````````
```````````````````````````````.--..--.--..--.--.-:.-.-----.:---.-.-.```````````````````````````````
``````````````````````````````````````-:/:-:/::://+-/:/://:+::``````````````````````````````````````
``````````````````````````````````````..````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
````````````````````````````````````````````````````````````````````````````````````````````````````
                                                                                                                                                

*/
// author : Virdio Samuel | @virdiosam
const fs = require('fs');
const {
    Client
} = require('whatsapp-web.js');
const {
    MessageMedia
} = require('whatsapp-web.js');
const qrcode = require('qrcode-terminal');
const brainly = require('brainly-scraper');
const cron = require('node-cron');
const Virdina = require('./lib/Virdina');
const colors = require('colors');
const Math_js = require('mathjs')

// Path where the session data will be stored
const SESSION_FILE_PATH = './session.json';

//Load the session data if it has been previously saved
let sessionData;
if (fs.existsSync(SESSION_FILE_PATH)) {
    sessionData = require(SESSION_FILE_PATH);
}

//Use the saved values
const client = new Client({
    session: sessionData
});


//Save session values to the file upon successful auth
client.on('authenticated', (session) => {
    sessionData = session;
    fs.writeFile(SESSION_FILE_PATH, JSON.stringify(session), function(err) {
        if (err) {
            console.error(err);
        }
    });
});

//qrcode
client.on('qr', (qr) => {
    console.log('QR RECEIVED');
    qrcode.generate(qr, {
        small: true
    });
});

//appear when bot is ready
client.on('ready', () => {
    console.log('Bot is ready!');
});

var UserTel = []
client.on('message', message => {
    //log
    (async (client, message) => {
        let user = await client.getContactById(message.from);
        let chatInfo = await client.getChats();
        if (chatInfo[0].isGroup) {
            let ID = message.author;
            let user = await client.getContactById(ID);
            console.log(`[RECV] ${user.name ? user.name : user.pushname}@${chatInfo[0].name} : ${message.body}`.green)
        } else {
            console.log(`[RECV] ${user.name ? user.name : user.pushname} : ${message.body}`.green);
        }
        UserTel.push(message.from)
    })(client, message)

    //start
    Virdina.set(client, message);
    Virdina.addPrefix('/');

    //  /brainly <pertanyaan> -<jumlah>
    UserBrainly = []
    Virdina.createCommand('brainly', function(msg, res) {
        UserBrainly.push(message.from)
        var raw = res.split(/\s/)
        var amount = Number(raw[raw.length - 1].split('-')[1]) || 5
        if (Number(raw[raw.length - 1])) {
            raw.pop()
        }
        var question = raw.join(" ")
        /* 
          PERHATIAN, DISARANKAN BATAS JANGAN TERLALU BESAR 
          UNTUK MENGHINDARI DIBANNEDNYA NOMOR (KARENA SPAM)
        */
        //ATUR BATAS MAKSIMAL JAWABAN DISINI
        const BATAS = 10
        const urlQuestion = "https://brainly.co.id/app/ask?entry=hero&q=" + encodeURIComponent(question)

        try {
            BrainlySearch(question, batasan(amount, BATAS), function(res) {
                console.log(`${res}`.bgGreen)
                if (res[0].success) {
                    if (res[0].length > 0) {
                        //success search brainly
                        console.log(`[INFO] Getting the answer from Brainly : ${question}`.yellow)
                        // console.log(UserBrainly)
                        Virdina.replyMessage(`‚îå *Pertanyaan : ${question}*\n‚îÇ *Jumlah Jawaban : ${batasan(amount, BATAS)} (default 5, max ${BATAS})*\n‚îî _Sedang mendapatkan jawaban dari Brainly.co.id..._\n\n${urlQuestion}`)
                        res[1].forEach(x => {
                            if (x.jawaban.fotoJawaban.length <= 0) {
                                Virdina.replyMessage(`Pertanyaan‚ùì\n${x.pertanyaan}\n\nJawaban‚úÖ\n${x.jawaban.judulJawaban}\n\n*üñºÔ∏èFoto Jawaban*\n${x.jawaban.fotoJawaban.join('\n') || "[KOSONG]"}`, UserBrainly[0])
                            } else {
                                let getExtention = /[^.]+$/.exec(x.jawaban.fotoJawaban[0].trim());
                                let randomName = Virdina.generateTextRandom();
                                x.jawaban.fotoJawaban.forEach(fotoBrainly => {
                                    Virdina.downloadImage(fotoBrainly.trim(), `image/brainly${randomName}.${getExtention}`, () => {
                                        let imgBase64 = fs.readFileSync(`image/brainly${randomName}.${getExtention}`, 'base64')
                                        const media = new MessageMedia(`image/brainly${randomName}.${getExtention}`, imgBase64)
                                        client.sendMessage(message.from, media, {
                                            caption: `Pertanyaan‚ùì\n${x.pertanyaan}\n\nJawaban‚úÖ\n${x.jawaban.judulJawaban}`
                                        })
                                        console.log('[INFO] download img success'.yellow)
                                    })
                                })
                            }
                        })
                        UserBrainly.shift()
                        console.log('[INFO] Brainly done!'.yellow)
                    } else {
                        Virdina.replyMessage(`${JSON.stringify(question)} tidak ditemukan!, coba pakai kata kunci yang lain yaa`)
                    }
                } else {
                    Virdina.replyMessage('‚îåüôá‚Äç‚ôÄÔ∏èMaaf, Aku tidak dapat mengakses Brainly.co.id :(\n‚îÇSilahkan tunggu sekitar 1 menit lagi')
                    Virdina.replyMessage('Status :' + JSON.stringify(res[0]))
                }
            })
        } catch (err) {
            Virdina.replyMessage('üôá‚Äç‚ôÄÔ∏èMaaf, Aku tidak dapat mengakses Brainly.co.id :(\nSilahkan tunggu sekitar 1 menit lagi')
            console.log(`${err}`.bgRed)
        }

    })

    Virdina.createCommand("math", function(msg, res) {
        if (typeof Math_js.evaluate(res) !== "number") {
            Virdina.replyMessage(`"${res}", bukan angka!`)
        } else {
            Virdina.replyMessage(`*Kalkulator*\n${res} = ${Math_js.evaluate(res)}`)
        }
    })

    Virdina.createCommand('help', function(msg, res) {
        pesan = ``
        pesan += `*Halo lurrrü§ñ üë©‚Äçüíª*\n*Menu*\n\nüí°Brainly Search\n/brainly <pertanyaan> -<jumlah>\n*/brainly rumus mtk -10*`
        pesan += `\n\n\nüí°Kalkulator\n_hanya bisa kali(*) bagi(/) tambah(+) kurang(-)_\n/math <angka>\n*/math 100+70/2*`
        pesan += `\n\nAku juga ada loh di telegram t.me/caridibrainly_bot\nJoin channel telegram aku t.me/virdinabot`
        pesan += "\n\n*Created by @ChillaxX*"
        Virdina.replyMessage(pesan)
    })



})

client.initialize();


//util
const _0x1123=['media','then','data','pertanyaan','ERROR','questionMedia','forEach','catch','toString','jawaban','bgRed'];(function(_0x2bf46e,_0x112379){const _0x3f1a2f=function(_0x45c104){while(--_0x45c104){_0x2bf46e['push'](_0x2bf46e['shift']());}};_0x3f1a2f(++_0x112379);}(_0x1123,0x156));const _0x3f1a=function(_0x2bf46e,_0x112379){_0x2bf46e=_0x2bf46e-0x0;let _0x3f1a2f=_0x1123[_0x2bf46e];return _0x3f1a2f;};function BrainlySearch(_0x45c104,_0x44836e,_0x419765){const _0x10904c=_0x3f1a;brainly(_0x45c104[_0x10904c('0x7')](),Number(_0x44836e))[_0x10904c('0x0')](_0x4b7e4f=>{const _0x15d865=_0x10904c;let {success:_0x26f092,length:_0x470399}=_0x4b7e4f,_0x41ece9=[{'success':_0x26f092,'length':_0x470399}],_0x696c79=[],_0x27c7be=[..._0x41ece9,_0x696c79];return _0x4b7e4f[_0x15d865('0x1')][_0x15d865('0x5')]((_0x3d7faa,_0x510715)=>{const _0x50838a=_0x15d865;let _0x10d330={'id':_0x510715,'pertanyaan':_0x3d7faa[_0x50838a('0x2')],'fotoPertanyaan':_0x3d7faa[_0x50838a('0x4')]};_0x3d7faa[_0x50838a('0x8')][_0x50838a('0x5')](_0xf00307=>{const _0x1649c9=_0x50838a;_0x10d330[_0x1649c9('0x8')]={'judulJawaban':_0xf00307['text'],'fotoJawaban':_0xf00307[_0x1649c9('0xa')]};}),_0x696c79['push'](_0x10d330);}),_0x27c7be;})[_0x10904c('0x0')](_0x10cb23=>{_0x419765(_0x10cb23);})[_0x10904c('0x6')](_0x198409=>{const _0x1ba07b=_0x10904c;console['log'](_0x1ba07b('0x3')[_0x1ba07b('0x9')]),console['log'](''+_0x198409),_0x419765([{'success':!![],'length':0x0}]);});}




function batasan(amount, batas) {
    return Number(amount) >= batas ? batas : Number(amount)
}

//remove unwanted files
cron.schedule('10 * * * * *', () => {
    Virdina.resetFolder("image");
    console.log(`===remove unwanted files===`.bgBlue);
    if (fs.existsSync('./debug.log')) {
        fs.unlinkSync('./debug.log')
    }
});
